#!/usr/bin/env python

import json, requests
from bs4 import BeautifulSoup

# Special thanks to 'mjv' (http://stackoverflow.com/users/166686/mjv) for http://stackoverflow.com/questions/1480356/how-to-submit-query-to-aspx-page-in-python.

def getUpcomingRides(stop):
	# Viewstate. May be fine to hardcode value, or may have to be refreshed each time / each day, by essentially running an extra page request and parse for this specific value.
	viewstate = '/wEPDwUKLTUyNjEwNDI1NQ9kFgJmD2QWAgIDD2QWBGYPDxYCHgRUZXh0BSNCcmFtcHRvbiBUcmFuc2l0IE5leHQgUmlkZSAtIE1vYmlsZWRkAgMPZBYKAgMPZBYEAgEPZBYCAgEPZBYCAgEPZBYGAgMPEGRkFgBkAgUPFgIeB1Zpc2libGVoFgQCAQ8WAh8BaGQCAw8QDxYKHwFoHgxEYXRhU291cmNlSURlHg1EYXRhVGV4dEZpZWxkBQZSb3V0ZU4eDkRhdGFWYWx1ZUZpZWxkBQZSb3V0ZUkeC18hRGF0YUJvdW5kZ2QQFQMXLS0tIFNob3cgQWxsIFJvdXRlcyAtLS0PMiAtIE1haW4sIFNvdXRoFTUwMiAtIFp1bSBNYWluLCBTb3V0aBUDATAEMjAwMwY1MDIwMDMUKwMDZ2dnFgFmZAIHDw8WAh8AZWRkAgIPZBYCAgEPZBYCAgEPZBYGAgEPEA8WCB8CZR8DBQZSb3V0ZU4fBAUGUm91dGVJHwVnZBAVcBYtLS0gU2VsZWN0IEEgUm91dGUgLS0tDzEgLSBRdWVlbiwgV2VzdA8xIC0gUXVlZW4sIEVhc3QPMiAtIE1haW4sIFNvdXRoDzIgLSBNYWluLCBOb3J0aBUzIC0gTWNMYXVnaGxpbiwgU291dGgVMyAtIE1jTGF1Z2hsaW4sIE5vcnRoFzQgLSBDaGluZ3VhY291c3ksIFNvdXRoFzQgLSBDaGluZ3VhY291c3ksIE5vcnRoETUgLSBCb3ZhaXJkLCBXZXN0ETUgLSBCb3ZhaXJkLCBFYXN0EjcgLSBLZW5uZWR5LCBTb3V0aBI3IC0gS2VubmVkeSwgTm9ydGgQOCAtIENlbnRyZSwgV2VzdBA4IC0gQ2VudHJlLCBFYXN0EDkgLSBWb2RkZW4sIFdlc3QQOSAtIFZvZGRlbiwgRWFzdBwxMCAtIFNvdXRoIEluZHVzdHJpYWwsIFNvdXRoHDEwIC0gU291dGggSW5kdXN0cmlhbCwgTm9ydGgSMTEgLSBTdGVlbGVzLCBXZXN0EjExIC0gU3RlZWxlcywgRWFzdBQxMiAtIEdyZW5vYmxlLCBTb3V0aBQxMiAtIEdyZW5vYmxlLCBOb3J0aBQxMyAtIEF2b25kYWxlLCBTb3V0aBQxMyAtIEF2b25kYWxlLCBOb3J0aBMxNCAtIFRvcmJyYW0sIFNvdXRoEzE0IC0gVG9yYnJhbSwgTm9ydGgUMTUgLSBCcmFtYWxlYSwgU291dGgUMTUgLSBCcmFtYWxlYSwgTm9ydGgVMTYgLSBTb3V0aGdhdGUsIFNvdXRoFTE2IC0gU291dGhnYXRlLCBOb3J0aBIxNyAtIEhvd2RlbiwgU291dGgSMTcgLSBIb3dkZW4sIE5vcnRoETE4IC0gRGl4aWUsIFNvdXRoETE4IC0gRGl4aWUsIE5vcnRoFjE5IC0gRmVybmZvcmVzdCwgU291dGgWMTkgLSBGZXJuZm9yZXN0LCBOb3J0aBoyMCAtIEVhc3QgSW5kdXN0cmlhbCwgV2VzdBoyMCAtIEVhc3QgSW5kdXN0cmlhbCwgRWFzdCEyMSAtIEhlYXJ0IExha2UsIENvdW50ZXJDbG9ja3dpc2UaMjEgLSBIZWFydCBMYWtlLCBDbG9ja3dpc2UVMjMgLSBTYW5kYWx3b29kLCBXZXN0FTIzIC0gU2FuZGFsd29vZCwgRWFzdBQyNCAtIFZhbiBLaXJrLCBTb3V0aBQyNCAtIFZhbiBLaXJrLCBOb3J0aBUyNSAtIEVkZW5icm9vaywgU291dGgVMjUgLSBFZGVuYnJvb2ssIE5vcnRoEzI5IC0gV2lsbGlhbXMsIFdlc3QTMjkgLSBXaWxsaWFtcywgRWFzdBgzMCAtIEFpcnBvcnQgUm9hZCwgU291dGgYMzAgLSBBaXJwb3J0IFJvYWQsIE5vcnRoEjMxIC0gTWNWZWFuLCBTb3V0aBIzMSAtIE1jVmVhbiwgTm9ydGgcMzIgLSBGYXRoZXIgVG9iaW4sIENsb2Nrd2lzZSYzMyAtIFBldGVyIFJvYmVydHNvbiwgQ291bnRlckNsb2Nrd2lzZRQzNSAtIENsYXJrd2F5LCBTb3V0aBQzNSAtIENsYXJrd2F5LCBOb3J0aB40MCAtIENlbnRyYWwgSW5kdXN0cmlhbCwgU291dGgeNDAgLSBDZW50cmFsIEluZHVzdHJpYWwsIE5vcnRoFTUwIC0gR29yZSBSb2FkLCBTb3V0aBU1MCAtIEdvcmUgUm9hZCwgTm9ydGgXNTEgLSBTdGVlbGVzIFdlc3QsIFdlc3QXNTEgLSBTdGVlbGVzIFdlc3QsIEVhc3QUNTIgLSBNY011cmNoeSwgU291dGgUNTIgLSBNY011cmNoeSwgTm9ydGgWNTMgLSBPYWtsZWEsIENsb2Nrd2lzZSM1NCAtIEphbWVzIFBvdHRlciwgQ291bnRlckNsb2Nrd2lzZRc1NiAtIFNwcmluZ2Jyb29rLCBTb3V0aBc1NiAtIFNwcmluZ2Jyb29rLCBOb3J0aBk2NSAtIFNlbmlvciBTaG9wcGVyLCBEaXIyGTY1IC0gU2VuaW9yIFNob3BwZXIsIERpcjEfOTIgLSBCcmFtYWxlYSBHTyBTaHV0dGxlLCBTb3V0aB85MiAtIEJyYW1hbGVhIEdPIFNodXR0bGUsIE5vcnRoJDExNSAtIFBlYXJzb24gQWlycG9ydCBFeHByZXNzLCBTb3V0aCQxMTUgLSBQZWFyc29uIEFpcnBvcnQgRXhwcmVzcywgTm9ydGgmMjAwIC0gVHVybmVyIEZlbnRvbiBTY2hvb2wgUm91dGUsIFdlc3QmMjAwIC0gVHVybmVyIEZlbnRvbiBTY2hvb2wgUm91dGUsIEVhc3QhMjAxIC0gTWF5ZmllbGQgU2Nob29sIFJvdXRlLCBXZXN0ITIwMSAtIE1heWZpZWxkIFNjaG9vbCBSb3V0ZSwgRWFzdCEyMDIgLSBNYXlmaWVsZCBTY2hvb2wgUm91dGUsIFdlc3QhMjAyIC0gTWF5ZmllbGQgU2Nob29sIFJvdXRlLCBFYXN0ITIwMyAtIE1heWZpZWxkIFNjaG9vbCBSb3V0ZSwgV2VzdCEyMDQgLSBNYXlmaWVsZCBTY2hvb2wgUm91dGUsIFdlc3QpMjA1IC0gU3QuIFRob21hcyBBcXVpbmFzIFNjaG9vbCBSb3UsIFdlc3QpMjA1IC0gU3QuIFRob21hcyBBcXVpbmFzIFNjaG9vbCBSb3UsIEVhc3QnMjA2IC0gU3QuIEF1Z3VzdGluZSBTY2hvb2wgUm91dGUsIFNvdXRoJzIwNiAtIFN0LiBBdWd1c3RpbmUgU2Nob29sIFJvdXRlLCBOb3J0aCIyMDcgLSBNYXlmaWVsZCBTY2hvb2wgUm91dGUsIFNvdXRoIjIwNyAtIE1heWZpZWxkIFNjaG9vbCBSb3V0ZSwgTm9ydGgiMjA4IC0gTWF5ZmllbGQgU2Nob29sIFJvdXRlLCBTb3V0aCIyMDggLSBNYXlmaWVsZCBTY2hvb2wgUm91dGUsIE5vcnRo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'
	payload = { '__VIEWSTATE': viewstate, 'ctl00$mainPanel$searchbyStop$txtStop': stop, 'ctl00$mainPanel$btnGetRealtimeSchedule': 'GO' }
	r = requests.post('http://nextride.brampton.ca/mob/SearchBy.aspx', data=payload)
	return r

if __name__=="__main__":
	stop = '2000'
	soup = BeautifulSoup(getUpcomingRides(stop).text)
	stopDesc = soup.find(id="ctl00_mainPanel_lblStopDescription")
	buses = soup.find(id="ctl00_mainPanel_gvSearchResult").find_all('tr')
	schedule = { 'stop': stopDesc.string.replace(',',':').replace(' at ',' / ') }
	routes = []
	for bus in buses[1:]:
		route = []
		for item in bus.stripped_strings:
			route.append(item)
		routes.append(route)
	schedule.update({ 'routes' : routes })
	print json.dumps(schedule, indent=4)
